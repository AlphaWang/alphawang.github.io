
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to Verify if Resilience4j Circuit Breaker Works - Alpha's Programming Notes</title>
  <meta name="author" content="Alpha Wang">

  
  <meta name="description" content="如何验证 Resilience4j Circuit Breaker">
  <meta name="keywords" content="distributed system, Resilience4j, Circuit Breaker">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alphawang.github.io/blog/how-to-verify-if-resilience4j-circuit-breaker-works">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Alpha's Programming Notes" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script>
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}

$(document).bind('DOMNodeInserted', function(event) {
  addBlankTargetForLinks();
});
</script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-54659411-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css" media="screen" />
<script type="text/javascript" src="/fancybox/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AlphaWang.com</a></h1>
  
    <h2>Alpha's Programming Notes | 一个程序员的日常</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alphawang.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/tag-cloud/">Tags</a></li>
  <li><a href="/photography/">Photo</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Verify if Resilience4j Circuit Breaker Works</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-12-23T17:20:44+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>5:20 pm</span></time>

        
      </p>
    
  </header>


<div class="entry-content"><p>Resilience4j is a widely-used library which inspired by Hystrix, it helps with building fault tolerance distributed systems. We are using its circuit breakder module to prevent a cascade of failures when a remote service is down.</p>

<p>You can implement a circuit break based on <a href="https://resilience4j.readme.io/docs/examples">the official manual</a>, and you may want to verify if it works well or not after . Here&rsquo;re some tips</p>

<!--more-->


<h2>Circuit Breaker Configurations</h2>

<p>Before the testing, it&rsquo;s a good idea to learn the Circuit Breaker Configurations, which are critical to a successful test. See some important configurations below:</p>

<ul>
<li><code>failureRateThreshold</code>: When the failure rate is equal or greater than the threshold the CircuitBreaker transitions to open and starts short-circuiting calls.</li>
<li><code>minimumNumberOfCalls</code>: it means the minimum number of calls which are required (per sliding window period) before the CircuitBreaker can calculate the error rate. For example, if minimumNumberOfCalls is 10, then at least 10 calls must be recorded, before the failure rate can be calculated. If only 9 calls have been recorded the CircuitBreaker will not transition to open even if all 9 calls have failed.</li>
<li><code>slidingWindowSize</code> / <code>ringBufferSizeInClosedState (legacy)</code>: the size of the sliding window which is used to record the outcome of calls when the CircuitBreaker is closed.</li>
<li><code>recordExceptions</code>: A list of exceptions that are recorded as a failure and thus increase the failure rate. If you specify a list of exceptions, all other exceptions count as a success.</li>
</ul>


<h2>Mock &amp; Test</h2>

<h3>Mock Thresholds</h3>

<p>The thresholds in production enviroment are usually configured as a large value and not convenient for testing. For example,</p>

<ul>
<li><code>minimumNumberOfCalls</code> might be 100, so you have to make 100 requests to trigger the error rate calculation.</li>
<li><code>slidingWindowSize / ringBufferSizeInClosedState</code> might be 100, so you have to make another 100 requests to complete the error rate calculation.</li>
<li><code>failureRateThreshold</code> might be 90, so you have to ensure 90% requests return exception so that the circuit breaker can be triggered to transit from CLOSED to OPEN.</li>
</ul>


<p>In short, reducing those thresholds in testing environment is recommended. For example, here&rsquo;s how I set them:</p>

<ul>
<li><code>minimumNumberOfCalls</code> = 1.</li>
<li><code>slidingWindowSize</code> = 5.</li>
<li><code>failureRateThreshold</code> = 10. (another option is mock a higher exception)</li>
</ul>


<h3>Mock Exceptions</h3>

<p>Next you need to mock exception when calling the remote service so that the circuit break can recognize the call as an error, then trigger the state transition after the error rate increased and reached the threshold.</p>

<p>The first thing to notice is, not all exceptions will be counted in the error rate. So it is a good idea to figure out what kind of exception you need to mock first. If you&rsquo;ve set <code>recordExceptions</code> on CircuitBreakerConfig, those exceptions are what you need to mock!</p>

<p>For example, below snippet means only ApiServerException will be counted in the error rate.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private static final CircuitBreakerConfig DEFAULT_CONFIG = CircuitBreakerConfig.custom()
</span><span class='line'>      .failureRateThreshold(10)
</span><span class='line'>      .slidingWindow(5, 1, SlidingWindowType.COUNT_BASED) 
</span><span class='line'>      .recordExceptions(ApiServerException.class) 
</span><span class='line'>      .build();</span></code></pre></td></tr></table></div></figure>


<p>So we need to mock ApiServerException during the remote call.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>private Object invoke(Object adapter, Object fluentRequest) {
</span><span class='line'>      if (count.incrementAndGet() % 2 == 0) {
</span><span class='line'>          throw new ApiServerException("MOCK-EXCEPTION");
</span><span class='line'>      }
</span><span class='line'>      
</span><span class='line'>      return remoteService.call();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Note: this example mocks the exception on api client side, you can also mock on the server side.</p></blockquote>

<h3>Testing</h3>

<p>Now you can request the target API, if the circuit breaker works well, you can find the state transit from CLOSED to OPEN once the error rate reachs the theshold. You may find a log like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CircuitBreaker 'xx' changed state from CLOSED to OPEN</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Note: assumed you&rsquo;ve attached onStateTransition event.</p>

<pre><code>circuitBreaker.getEventPublisher().onStateTransition(event -&gt;
          log.warn("{}, {}", circuitBreaker.getName(), event.getStateTransition()));
</code></pre></blockquote>

<h2>Conclusion</h2>

<p>In short, reducing those thresholds in testing environment is recommended, and mock exception when calling the remote service, then you can verify the state transition by monitoring the logs.</p>

<h2>One More Thing</h2>

<p>You may found changing the thresholds is a tedious job which need to change the code and deploy, I recommend store the thresholds in a <a href="https://medium.com/@theparanoidengr/an-overview-of-config-management-in-microservices-architecture-efa815035316">Configuration Center</a>, so that you can config a lower value for testing environment without touching the code while not affect production environment.</p>

<p>Another benefit of integrating it with Configuration Center is that you can easily adjust the thresholds to fit the real world at any time.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alpha Wang</span></span>

      




<time class='entry-date' datetime='2019-12-23T17:20:44+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>5:20 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/distributed-system/'>distributed system</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
  	
<!--Baidu Share-->
<div class="bdsharebuttonbox">
<a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
<a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
<a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
<a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
<a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
<a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
<a href="#" class="bds_more" data-cmd="more"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"",
"bdStyle":"2", //1
"bdSize":"24"},
"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


<!--Google Adsense-->
<p class="meta" style="text-align:center">
	<!-- 728*90 -->
	<!--
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<ins class="adsbygoogle"
	     style="display:inline-block;width:728px;height:90px"
	     data-ad-client="ca-pub-6393503301700908"
	     data-ad-slot="2039334876"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	-->
	
	<!-- 789*90 -->
	<!--
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<ins class="adsbygoogle"
	     style="display:inline-block;width:789px;height:90px"
	     data-ad-client="ca-pub-6393503301700908"
	     data-ad-slot="7806666870"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	-->
</p>

<!-- UY BEGIN -->
<!--<div id="uyan_frame"></div>-->
<!--<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1965224"></script>-->
<!-- UY END -->
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/clean-code/" title="Previous Post: Clean Code Summary">&laquo; Clean Code Summary</a>
      
      
        <a class="basic-alignment right" href="/blog/pulsar-load-balancing/" title="Next Post: 详解 Pulsar Broker 负载均衡">详解 Pulsar Broker 负载均衡 &raquo;</a>
      
    </p>

    <!-- Gitalk 评论 start  -->

    <!-- Link Gitalk 的支持文件  -->
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
    <div id="gitalk-container"></div>     <script type="text/javascript">
      var gitalk = new Gitalk({

          // gitalk的主要参数
          clientID: 'd4cba670eb5bd4b63a2e',
          clientSecret: '5a3498bf127676c9aaacf738a8b26d976154fad3',
          repo: 'alphawang.github.io',
          owner: 'AlphaWang',
          admin: ['AlphaWang'],
          id: location.pathname,

      });
      gitalk.render('gitalk-container');
    </script>
    <!-- Gitalk end -->
  </footer>
</article>

  

</div>

<aside class="sidebar">
  
    <section>
 <h1>Categories</h1>
 <ul id="categories">
	 <li class='category'><a href='/blog/categories/design-patterns/'>design patterns (7)</a></li>
<li class='category'><a href='/blog/categories/distributed-system/'>distributed system (4)</a></li>
<li class='category'><a href='/blog/categories/java/'>java (12)</a></li>
<li class='category'><a href='/blog/categories/mac/'>mac (2)</a></li>
<li class='category'><a href='/blog/categories/messaging/'>messaging (2)</a></li>
<li class='category'><a href='/blog/categories/nosql/'>nosql (1)</a></li>
<li class='category'><a href='/blog/categories/site/'>site (1)</a></li>
<li class='category'><a href='/blog/categories/solr/'>solr (2)</a></li>
<li class='category'><a href='/blog/categories/translation/'>translation (3)</a></li>
<li class='category'><a href='/blog/categories/web/'>web (1)</a></li>

 </ul>
</section>
<section>
<h1>Tags</h1>
<ul class="tag-cloud">
	<a style="font-size: 90%" href="/blog/tags/css/">CSS</a>
<a style="font-size: 119%" href="/blog/tags/collection/">Collection</a>
<a style="font-size: 171%" href="/blog/tags/design-pattern/">Design Pattern</a>
<a style="font-size: 119%" href="/blog/tags/guava/">Guava</a>
<a style="font-size: 171%" href="/blog/tags/jdk/">JDK</a>
<a style="font-size: 90%" href="/blog/tags/jmm/">JMM</a>
<a style="font-size: 90%" href="/blog/tags/jvm/">JVM</a>
<a style="font-size: 210%" href="/blog/tags/java/">Java</a>
<a style="font-size: 90%" href="/blog/tags/kafka/">Kafka</a>
<a style="font-size: 119%" href="/blog/tags/mac/">Mac</a>
<a style="font-size: 90%" href="/blog/tags/photography/">Photography</a>
<a style="font-size: 119%" href="/blog/tags/pulsar/">Pulsar</a>
<a style="font-size: 90%" href="/blog/tags/resilience/">Resilience</a>
<a style="font-size: 164%" href="/blog/tags/solid/">SOLID</a>
<a style="font-size: 119%" href="/blog/tags/site/">Site</a>
<a style="font-size: 119%" href="/blog/tags/solr/">Solr</a>
<a style="font-size: 164%" href="/blog/tags/source-code/">Source Code</a>
<a style="font-size: 90%" href="/blog/tags/spring-mvc/">Spring MVC</a>
<a style="font-size: 119%" href="/blog/tags/spring-solr/">Spring Solr</a>
<a style="font-size: 136%" href="/blog/tags/string/">String</a>
<a style="font-size: 119%" href="/blog/tags/tool/">Tool</a>
<a style="font-size: 119%" href="/blog/tags/web/">Web</a>
<a style="font-size: 90%" href="/blog/tags/ajax/">ajax</a>
<a style="font-size: 90%" href="/blog/tags/clean-code/">clean code</a>
<a style="font-size: 90%" href="/blog/tags/cluster/">cluster</a>
<a style="font-size: 90%" href="/blog/tags/dapper/">dapper</a>
<a style="font-size: 148%" href="/blog/tags/distributed-system/">distributed system</a>
<a style="font-size: 119%" href="/blog/tags/messaging/">messaging</a>
<a style="font-size: 90%" href="/blog/tags/nosql/">nosql</a>
<a style="font-size: 90%" href="/blog/tags/redis/">redis</a>
<a style="font-size: 90%" href="/blog/tags/sentinel/">sentinel</a>
<a style="font-size: 90%" href="/blog/tags/tracing/">tracing</a>
<a style="font-size: 119%" href="/blog/tags/translation/">translation</a>
<a style="font-size: 90%" href="/blog/tags/dai-ma-zheng-ji-zhi-dao/">代码整洁之道</a>
<a style="font-size: 90%" href="/blog/tags/xue-xi-zong-jie/">学习总结</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/kafka-versus-pulsar/">Apache Pulsar 与 Apache Kafka 之对比分析</a>
      </li>
    
      <li class="post">
        <a href="/blog/pulsar-load-balancing/">详解 Pulsar Broker 负载均衡</a>
      </li>
    
      <li class="post">
        <a href="/blog/how-to-verify-if-resilience4j-circuit-breaker-works/">How to Verify if Resilience4j Circuit Breaker Works</a>
      </li>
    
      <li class="post">
        <a href="/blog/clean-code/">Clean Code Summary</a>
      </li>
    
      <li class="post">
        <a href="/blog/redis-mind-map/">Redis Mind Map</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Links</h1>
  <ul id="recent_posts">
    <li class="post"><a href="https://alpha.blog.csdn.net/">Alpha's CSDN Blog</a></li>
    <li class="post"><a href="https://github.com/AlphaWang/">Alpha's Github</a></li>
  </ul>
</section><section>
  <h1>Visitors Map</h1>
  <div class="earth">
    <script type="text/javascript" src="//ri.revolvermaps.com/0/0/8.js?i=awaok66hddi&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=49" async="async"></script>
  </div>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Alpha Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253224710'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s5.cnzz.com/z_stat.php%3Fid%3D1253224710%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  











</body>
</html>
