
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Learning JDK Source Code: Negative Examples - Alpha's Programming Notes</title>
  <meta name="author" content="Alpha Wang">

  
  <meta name="description" content="本文记录了一些Java源码中设计不合理之处、违反设计模式之处，以及其他可以改进的地方。">
  <meta name="keywords" content="Java, Design Patterns">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alphawang.github.io/blog/learning-jdk-negative-examples">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Alpha's Programming Notes" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script>
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}

$(document).bind('DOMNodeInserted', function(event) {
  addBlankTargetForLinks();
});
</script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-54659411-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css" media="screen" />
<script type="text/javascript" src="/fancybox/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AlphaWang.com</a></h1>
  
    <h2>Alpha's Programming Notes | 一个程序员的日常</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alphawang.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/tag-cloud/">Tags</a></li>
  <li><a href="/photography/">Photo</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Learning JDK Source Code: Negative Examples</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-01T15:00:45+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>3:00 pm</span></time>

        
      </p>
    
  </header>


<div class="entry-content"><p>本文记录了一些Java源码中设计不合理之处、违反设计模式之处，以及其他可以改进的地方。</p>

<!--more-->


<h1>1. 构造对象语法</h1>

<h2>参数化类型的构造函数啰嗦</h2>

<p>如果你调用参数化类的构造函数，那么你必须要指定类型参数，即便上下文中已明确了类型参数。这通常要求你连续两次提供类型参数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Map</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>而假设HashMap提供了如下静态工厂：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span>  <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">HashMap</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="nf">newInstance</span><span class="o">(){</span>
</span><span class='line'>   <span class="k">return</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么你就可以讲上文冗长的声明替换为如下这种简洁的形式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Map</span> <span class="o">&lt;</span> <span class="n">String</span><span class="o">,</span> <span class="n">List</span> <span class="o">&lt;</span> <span class="n">String</span> <span class="o">&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">HashMap</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>补充1：<code>com.google.common.collect.Lists</code>可以解决这个问题：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">List</span> <span class="o">&lt;</span> <span class="n">String</span> <span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>     <span class="kd">public</span>   <span class="kd">static</span>  <span class="n">ArrayList</span>  <span class="nf">newArrayList</span> <span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span>   <span class="k">new</span>  <span class="nf">ArrayList</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>补充2：Java7做了优化，可以这样声明：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Map</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<h1>2. 创建了不必要的对象</h1>

<h2>Boolean(String)</h2>

<p><code>Boolean(String)</code>有点多余，因为已经有<strong>静态工厂方法</strong>：<code>Boolean.valueOf(String)</code>，它比Boolean(String)更可取。</p>

<p>构造函数每次被调用时都会创建一个新对象，而静态工厂方法则从来不要求这样做，实际上也不会这么做。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nf">Boolean</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">(</span><span class="n">toBoolean</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">toBoolean</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">((</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;true&quot;</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="nf">valueOf</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">toBoolean</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Boolean</span> <span class="n">TRUE</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Boolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Boolean</span> <span class="n">FALSE</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Boolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h1>3. 误用finalize</h1>

<p>要避免用finalize来释放资源，而<strong>应该提供一个显式的终止方法</strong>。例如FileInputStream.close();</p>

<p><strong>finalizer的作用之一是，可以充当“安全网”，以防对象所有者忘记调用显式的终止方法</strong>。虽然不能保证finalizer会被及时调用，但当客户端没有调用显式终止方法时，迟一点释放资源总比不释放好。不过如果finalizer发现有未被终止的资源，则必须打印一条警告，表明客户端代码有bug，需要修复。</p>

<p>唯一声称保证finalizer()会被执行的方法是<code>System.runFinalizersOnExit</code>，以及<code>Runtime.runFinalizersOnExit</code>。</p>

<blockquote><p>但这两个方法都有致命缺陷并且都已弃用。</p></blockquote>

<h2>FileInputStream.finalize()</h2>

<p>JDK有四个类（<code>FileInputStream</code>、<code>FileOutputStream</code>、<code>Timer</code>、<code>Connection</code>）使用了finalizer作为安全网，以防显式终止方法未被调用。不幸的是，这些finalizer都没有打印警告。当API发布后，这种警告一般就不能添加到API了，因为可能破坏已有的客户端代码。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Ensures that the &lt;code&gt;close&lt;/code&gt; method of this file input stream is</span>
</span><span class='line'><span class="cm"> * called when there are no more references to it.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @exception  IOException  if an I/O error occurs.</span>
</span><span class='line'><span class="cm"> * @see        java.io.FileInputStream#close()</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// should log an error!</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">((</span><span class="n">fd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span>  <span class="o">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="n">FileDescriptor</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>4. 违反equals约定</h1>

<h2>URL.equals()</h2>

<p><code>java.net.UR</code>L的equals方法依赖于对URL中主机的IP地址的比较，而将主机名转译成IP地址需要访问网络，随着时间推移，并不保证能返回相同的结果。</p>

<p>——<strong>违反一致性</strong>。这就会导致URL的equals方法违反约定，并且已经在实践中引起问题了。</p>

<blockquote><p>不幸的是，由于兼容性需求，这一行为无法改变。除了少数例外情况，equals方法必须对驻留在内存中的对象进行确定性计算。</p></blockquote>

<h2>Timestamp.euals()</h2>

<p><code>java.sql.Timestamp</code>扩展了<code>java.util.Date</code>类并增加了<code>nanoseconds</code>字段。其equals方法<strong>违反了对称性</strong>：如果Timestamp和Date被用于同一个集合中，或以其他什么方式混在一起使用，则会引起错误的行为。</p>

<blockquote><p>无法在扩展可实例化类（即非抽象类）的时候，增加一个值组件，同时又保证equals约定。</p></blockquote>

<p><code>Timestamp</code>有一个免责声明，提醒程序员不要混用Date和Timestamp。虽然只要不混用他们就不会有麻烦，但是谁都不能阻止你混用他们，而结果导致的错误将会很难调试。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Note: This method is not symmetric with respect to the</span>
</span><span class='line'><span class="cm"> * &lt;code&gt;equals(Object)&lt;/code&gt; method in the base class.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ts</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">ts</span> <span class="k">instanceof</span> <span class="n">Timestamp</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">equals</span><span class="o">((</span><span class="n">Timestamp</span><span class="o">)</span><span class="n">ts</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>5. compareTo与equals不一致</h1>

<p>compareTo方法的等同性测试必须与equals方法的结果相同。如果遵守了这一条，则称compareTo方法所施加的顺序与equals一致；反之则称为与equals不一致。</p>

<p>当然与equals不一致的compareTo方法仍然是可以工作的。但是，如果一个有序集合包含了该类的元素，则这个集合可能就不能遵守相应集合接口（Collection、Set、Map）的通用约定。这是因为<strong>这些集合接口的通用约定是基于equals方法的，但是有序集合却使用了compareTo而非equals来执行等同性测试</strong>。</p>

<h2>BigDecimal.compareTo()</h2>

<p>BigDecimal类的compareTo方法与equals不一致：</p>

<ul>
<li>如果创建一个<code>HashSet</code>实例，并添加两个元素<code>new BigDecimal("1.0")</code>和<code>new BigDecimal("1.00")</code>，则集合会包含两个元素，因为这两个实例通过equals检测并不相等；</li>
<li>而如果使用<code>TreeSet</code>而非HashSet，则集合中会只包含一个元素，因为这两个实例通过compareTo检测是相等的。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">BigDecimal</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// Quick path for equal scale and non-inflated case.</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">scale</span> <span class="o">==</span> <span class="n">val</span><span class="o">.</span><span class="na">scale</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>       <span class="kt">long</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">intCompact</span><span class="o">;</span>
</span><span class='line'>       <span class="kt">long</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="na">intCompact</span><span class="o">;</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(</span><span class="n">xs</span> <span class="o">!=</span> <span class="n">INFLATED</span> <span class="o">&amp;&amp;</span> <span class="n">ys</span> <span class="o">!=</span> <span class="n">INFLATED</span><span class="o">)</span>
</span><span class='line'>           <span class="k">return</span> <span class="n">xs</span> <span class="o">!=</span> <span class="n">ys</span> <span class="o">?</span> <span class="o">((</span><span class="n">xs</span> <span class="o">&gt;</span> <span class="n">ys</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">xsign</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">signum</span><span class="o">();</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">ysign</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="na">signum</span><span class="o">();</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">xsign</span> <span class="o">!=</span> <span class="n">ysign</span><span class="o">)</span>
</span><span class='line'>       <span class="k">return</span> <span class="o">(</span><span class="n">xsign</span> <span class="o">&gt;</span> <span class="n">ysign</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">xsign</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>       <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">compareMagnitude</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">(</span><span class="n">xsign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">cmp</span> <span class="o">:</span> <span class="o">-</span><span class="n">cmp</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(!(</span><span class="n">x</span> <span class="k">instanceof</span> <span class="n">BigDecimal</span><span class="o">))</span>
</span><span class='line'>       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>   <span class="n">BigDecimal</span> <span class="n">xDec</span> <span class="o">=</span> <span class="o">(</span><span class="n">BigDecimal</span><span class="o">)</span> <span class="n">x</span><span class="o">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span>
</span><span class='line'>       <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">scale</span> <span class="o">!=</span> <span class="n">xDec</span><span class="o">.</span><span class="na">scale</span><span class="o">)</span>
</span><span class='line'>       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>   <span class="kt">long</span> <span class="n">s</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">intCompact</span><span class="o">;</span>
</span><span class='line'>   <span class="kt">long</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">xDec</span><span class="o">.</span><span class="na">intCompact</span><span class="o">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">INFLATED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(</span><span class="n">xs</span> <span class="o">==</span> <span class="n">INFLATED</span><span class="o">)</span>
</span><span class='line'>           <span class="n">xs</span> <span class="o">=</span> <span class="n">compactValFor</span><span class="o">(</span><span class="n">xDec</span><span class="o">.</span><span class="na">intVal</span><span class="o">);</span>
</span><span class='line'>       <span class="k">return</span> <span class="n">xs</span> <span class="o">==</span> <span class="n">s</span><span class="o">;</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">xs</span> <span class="o">!=</span> <span class="n">INFLATED</span><span class="o">)</span>
</span><span class='line'>       <span class="k">return</span> <span class="n">xs</span> <span class="o">==</span> <span class="n">compactValFor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">intVal</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">inflate</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">xDec</span><span class="o">.</span><span class="na">inflate</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>6. 接口设计问题</h1>

<h2>Cloneable接口</h2>

<p>Cloneable接口的目的是作为对象的一个mixin接口，表明对象允许克隆；但这个目的没有达到。</p>

<p>其主要缺点是，Cloneable缺少一个<code>clone()</code>方法，而<code>Object.clone()</code>是受保护的。</p>

<p>通常，实现接口是为了表明类可以为它的客户做些什么；而<strong>Cloneable却改变了超类中受保护方法的行为</strong>。</p>

<blockquote><p>——区别java.rmi.Remote接口，其中也不具有任何方法，它是一个记号接口。</p></blockquote>

<h1>7. public类不应暴露其内部字段</h1>

<p>如果一个类可以被包外访问，那么就要提供访问方法，以便可以灵活地改变类的内部表示。如果public类暴露了其数据域，那就不能在将来改变内部表示了。</p>

<h2>Point</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Point</span> <span class="kd">extends</span> <span class="n">Point2D</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The X coordinate of this &lt;code&gt;Point&lt;/code&gt;.</span>
</span><span class='line'><span class="cm">     * If no X coordinate is set it will default to 0.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The Y coordinate of this &lt;code&gt;Point&lt;/code&gt;.</span>
</span><span class='line'><span class="cm">     * If no Y coordinate is set it will default to 0.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Dimension</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dimension</span> <span class="kd">extends</span> <span class="n">Dimension2D</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The width dimension; negative values can be used.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * The height dimension; negative values can be used.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>8. 不可变类的设计</h1>

<h2>不可变类无需提供拷贝构造函数: String(String  original)：</h2>

<p>不可变对象可以自由共享，所以无需进行保护性拷贝。实际上你根本无需做任何拷贝，<strong>因为这些拷贝始终与源对象相等</strong>。因此，<strong>你不需要，也不应该为不可变类提供clone方法或者拷贝构造函数</strong>。</p>

<p>【反例】这一点在Java平台早期并没有被很好地理解，导致String类具有拷贝构造函数，应该尽量不去用这个函数。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Initializes a newly created {@code String} object so that it represents</span>
</span><span class='line'><span class="cm"> * the same sequence of characters as the argument; in other words, the</span>
</span><span class='line'><span class="cm"> * newly created string is a copy of the argument string. Unless an</span>
</span><span class='line'><span class="cm"> * explicit copy of {@code original} is needed, use of this constructor is</span>
</span><span class='line'><span class="cm"> * unnecessary since Strings are immutable.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @param  original</span>
</span><span class='line'><span class="cm"> *         A {@code String}</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="nf">String</span><span class="o">(</span><span class="n">String</span> <span class="n">original</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">hash</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>不可变类应该不能继承: BigInteger / BigDecimal：</h2>

<p>当BigInteger和BigDecimal编写出来时，对于“<strong>不可变类实际上必须final</strong>”并没有得到广泛的理解，所以这两个类的方法都可以被重写。不幸的是，为了保持向后兼容，这个问题一直没有得到修正。</p>

<p>如果你编写的类的安全性依赖于（来自不可信客户端的）BigInteger或BigDecimal的不可变性，那么就必须检查参数是真正的BigInteger/BigDecimal，还是不可信任的子类实例。如果是后者，你必须把它当成是可变的，并进行保护性拷贝：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">BigInteger</span> <span class="nf">safeInstance</span><span class="o">(</span><span class="n">BigInteger</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">val</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">BigInteger</span><span class="o">.</span><span class="na">class</span> <span class="o">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">BigInteger</span><span class="o">(</span><span class="n">val</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Date,  Point：理应设计成不可变类</h2>

<p>应该永远让小的值对象不可变，例如PhoneNumber、Complex。
Java平台库中有许多这种类，例如<code>java.util.Date</code>、<code>java.awt.Point</code>，它们理论上应当是不可变的，但实际上却是可变的。</p>

<h2>EnumSet理应不可变</h2>

<h1>9. 异常设计</h1>

<h2>finally中应该禁止return</h2>

<p>It is especially difficult to understand the behavior of a program that executes a break, continue, or return statement in a Try block only to have the statement&rsquo;s behavior vetoed by a finally block.</p>

<p><strong>Never exit a finally block with a return, break, continue, or throw, and never allow a checked exception to propagate out of a finally block.</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">decision</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个程序返回false。无论try块是否正常执行完，finnaly都会被执行。</p>

<h2>finally中应该禁止抛出异常</h2>

<p>另外，finally中应该禁止抛出异常。否则finally中剩下的语句就不会执行，破坏逻辑。</p>

<h2>继承方法抛出的异常</h2>

<p>The set of checked exceptions that a method can throw is the <strong>intersection</strong> of the sets of checked exceptions that it is declared to throw in all applicable types, <strong>not the union</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">interface</span> <span class="nc">Type1</span> <span class="o">{</span>
</span><span class='line'>     <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CloneNotSupportedException</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">interface</span> <span class="nc">Type2</span> <span class="o">{</span>
</span><span class='line'>     <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">interface</span> <span class="nc">Type3</span> <span class="kd">extends</span> <span class="n">Type1</span><span class="o">,</span> <span class="n">Type2</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Arcane3</span> <span class="kd">implements</span> <span class="n">Type3</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">&quot;Hello world&quot;</span> <span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Type3</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Arcane3</span><span class="o">();</span>
</span><span class='line'>         <span class="n">t3</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>   <span class="c1">// 不抛异常！！！</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>10. 类型转换</h1>

<h2>int相乘可能溢出</h2>

<p>两个int相乘，得到的还是int，这就可能溢出！</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">long</span> <span class="n">MICROS_PER_DAY</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">//不精确</span>
</span><span class='line'><span class="kt">long</span> <span class="n">MICROS_PER_DAY</span> <span class="o">=</span> <span class="mi">24</span> <span class="n">L</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">//精确</span>
</span></code></pre></td></tr></table></div></figure>


<p>应该自动切换到更大的类型，以避免溢出；
或者直接抛出Exception，都比溢出要好。</p>

<h2>mixed-type computations</h2>

<p>如果遇到跨类型计算，jdk会把低类型自动提升为高类型，然后再计算。但这种转换有时会导致问题。例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="mh">0x100000000</span><span class="n">L</span> <span class="o">+</span> <span class="mh">0xcafebabe</span><span class="o">);</span> <span class="c1">//cafebabe</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为是long + int，所以后面的int会自动提升为long，再计算。即被提升为0xffffffffcafebabeL。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="mh">0xffffffffcafebabe</span><span class="n">L</span>
</span><span class='line'><span class="o">+</span> <span class="mh">0x0000000100000000</span><span class="n">L</span>
</span><span class='line'><span class="o">=</span> <span class="mh">0x00000000cafebabe</span><span class="n">L</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以得到cafebase，而不是想象中的1cafebabe。
我们得出教训：<strong>跨类型计算可能带来混淆，所以要坚决避免！</strong>上例可以改为如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="mh">0x100000000</span><span class="n">L</span> <span class="o">+</span> <span class="mh">0xcafebabe</span><span class="n">L</span><span class="o">);</span> <span class="c1">//1cafebabe</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Negative hex literals appear positive。十六进制的字面值，其最高位代表正负。</p></blockquote>

<h2>三元运算符的操作数类型</h2>

<p>要注意三元运算符，它没有要求第二和第三个操作数类型一致。</p>

<ol>
<li>如果类型都为T；则结果为T。</li>
<li>如果其中一个类型T为byte/shor/char，另一个是int常量；则结果为T。</li>
<li>如果为其他情况，则结果为提升类型。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="sc">&#39;X&#39;</span><span class="o">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="kc">false</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="n">x</span><span class="o">);</span> <span class="c1">//输出88，结果为int类型</span>
</span></code></pre></td></tr></table></div></figure>


<p>理应强制要求他们类型一致。</p>

<h2>+=和-=的自动类型转换：损失精度</h2>

<p><code>+=</code>、<code>-=</code>等运算符会自动类型转换，即将计算结果自动转换为左侧操作数的类型。这有时会导致意想不到的问题。
例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">short</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">123456</span><span class="o">;</span>
</span><span class='line'><span class="n">x</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span> <span class="c1">//自动转换为short，损失精度，但不报错</span>
</span><span class='line'><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span> <span class="c1">// Won&#39;t compile - &quot;possible loss of precision&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>应该不要做自动类型转换，以编译报错提醒用户。（与第二句普通赋值语句保持一致）</p>

<ul>
<li>——另外一个问题，<code>+=</code>左侧不能为Object，例如：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Object</span> <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Buy &quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">String</span> <span class="n">i</span> <span class="o">=</span> <span class="s">&quot;Effective Java!&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>  <span class="c1">//合法</span>
</span><span class='line'><span class="n">x</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>     <span class="c1">//非法</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>——Narrowing Primitive Conversion
An unfortunate fact about the compound assignment operators is that they can silently perform narrowing primitive conversions , which are conversions from one numeric type to a less expressive numeric type.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>    <span class="n">i</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>初始值为0xffff；</li>
<li>执行>>>=时，先将其提升为int，变为0xffffffff；</li>
<li>接着移位，变为0x7fffffff；</li>
<li>接着赋值回i，这时会执行从int到short的转换，变为0xffff</li>
</ol>


<p>所以上例是一个无限循环。</p>

<h1>11. 语言设计</h1>

<h2>long字面值可以用小写L</h2>

<p>用小写L容易与数字1混淆！
应该强制用大写L，小写L非法。</p>

<h2>重写toString()</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Object</span> <span class="n">numbers</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[]</span> <span class="o">{</span> <span class="sc">&#39;1&#39;</span><span class="o">,</span> <span class="sc">&#39;2&#39;</span><span class="o">,</span> <span class="sc">&#39;3&#39;</span> <span class="o">};</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">numbers</span><span class="o">);</span> <span class="c1">// [C@16f0472</span>
</span></code></pre></td></tr></table></div></figure>


<p>貌似Array应该默认重写toString方法。</p>

<h2>不能静态导入Arrays.toString()</h2>

<p>为了解决上一个问题，你可能想静态导入Arrays.toString()，然后调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">toString</span><span class="o">(</span><span class="n">numbers</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是会编译报错，编译器去查找当前类的toString()方法，发现参数不匹配。。</p>

<h2>String(byte[])依赖于默认字符集</h2>

<p>String(byte[])的文档说明，它依赖于默认字符集：</p>

<blockquote><p>Constructs a new String by decoding the specified byte array <strong>using the platform&rsquo;s default charset</strong>. The length of the new String is a function of the charset, and hence may not be equal to the length of the byte array. The behavior of this constructor when the given bytes are not valid in the default charset is unspecified。</p></blockquote>

<p>但是JRE的默认字符集依赖于操作系统和locale。所以，it was not such a good idea to provide a String(byte[]) constructor that depends on the default charset:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">&quot;ISO-8859-1&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>final字段与final方法的含义完全不同</h2>

<h2>Thread.run()不应该公开</h2>

<ul>
<li>Thread.run()是一个public方法，很可能导致被误调用——想调start()，结果却调了run() 。</li>
<li>If <code>Thread</code> didn&rsquo;t have a public <code>run</code> method, it would be impossible for programmers to invoke it accidentally.</li>
<li>The <code>Thread</code> class has a public <code>run</code> method because it implements <code>Runnable</code>, but it didn&rsquo;t have to be that way.</li>
<li>An alternative design would be for each <code>Thread</code> instance to encapsulate a <code>Runnable</code>, giving rise to composition in place of interface inheritance.</li>
</ul>


<h2>方法名不合理</h2>

<p>methods should have names that describe their primary functions. Given the behavior of <code>Thread.interrupted</code>, it should have been named <code>clearInterruptStatus</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">* Tests if some Thread has been interrupted. The interrupted state</span>
</span><span class='line'><span class="cm">* is reset or not based on the value of ClearInterrupted that is</span>
</span><span class='line'><span class="cm">* passed.</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">isInterrupted</span><span class="o">(</span> <span class="kt">boolean</span> <span class="n">ClearInterrupted</span> <span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">interrupted</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nf">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isInterrupted</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nf">isInterrupted</span><span class="o">(</span> <span class="kc">false</span> <span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>shadow local variables</h2>

<p>perhaps it makes sense to forbid shadowing of type parameters, in the same way that shadowing of local variables is forbidden.</p>

<p>未完待续。。。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alpha Wang</span></span>

      




<time class='entry-date' datetime='2014-12-01T15:00:45+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>3:00 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/java/'>java</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
  	
<!--Baidu Share-->
<div class="bdsharebuttonbox">
<a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
<a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
<a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
<a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
<a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
<a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
<a href="#" class="bds_more" data-cmd="more"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"",
"bdStyle":"2", //1
"bdSize":"24"},
"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


<!--Google Adsense-->
<p class="meta" style="text-align:center">
	<!-- 728*90 -->
	<!--
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<ins class="adsbygoogle"
	     style="display:inline-block;width:728px;height:90px"
	     data-ad-client="ca-pub-6393503301700908"
	     data-ad-slot="2039334876"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	-->
	
	<!-- 789*90 -->
	<!--
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<ins class="adsbygoogle"
	     style="display:inline-block;width:789px;height:90px"
	     data-ad-client="ca-pub-6393503301700908"
	     data-ad-slot="7806666870"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	-->
</p>

<!-- UY BEGIN -->
<!--<div id="uyan_frame"></div>-->
<!--<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1965224"></script>-->
<!-- UY END -->
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/how-to-implement-a-hashmap/" title="Previous Post: How to Implement a HashMap ">&laquo; How to Implement a HashMap </a>
      
      
        <a class="basic-alignment right" href="/blog/learning-jdk-positive-examples/" title="Next Post: Learning JDK Source Code: Positive Examples">Learning JDK Source Code: Positive Examples &raquo;</a>
      
    </p>

    <!-- Gitalk 评论 start  -->

    <!-- Link Gitalk 的支持文件  -->
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
    <div id="gitalk-container"></div>     <script type="text/javascript">
      var gitalk = new Gitalk({

          // gitalk的主要参数
          clientID: 'd4cba670eb5bd4b63a2e',
          clientSecret: '5a3498bf127676c9aaacf738a8b26d976154fad3',
          repo: 'alphawang.github.io',
          owner: 'AlphaWang',
          admin: ['AlphaWang'],
          id: location.pathname,

      });
      gitalk.render('gitalk-container');
    </script>
    <!-- Gitalk end -->
  </footer>
</article>

  

</div>

<aside class="sidebar">
  
    <section>
 <h1>Categories</h1>
 <ul id="categories">
	 <li class='category'><a href='/blog/categories/design-patterns/'>design patterns (6)</a></li>
<li class='category'><a href='/blog/categories/distributed-system/'>distributed system (1)</a></li>
<li class='category'><a href='/blog/categories/java/'>java (12)</a></li>
<li class='category'><a href='/blog/categories/mac/'>mac (2)</a></li>
<li class='category'><a href='/blog/categories/site/'>site (1)</a></li>
<li class='category'><a href='/blog/categories/solr/'>solr (2)</a></li>
<li class='category'><a href='/blog/categories/web/'>web (1)</a></li>

 </ul>
</section>
<section>
<h1>Tags</h1>
<ul class="tag-cloud">
	<a style="font-size: 90%" href="/blog/tags/css/">CSS</a>
<a style="font-size: 119%" href="/blog/tags/collection/">Collection</a>
<a style="font-size: 171%" href="/blog/tags/design-pattern/">Design Pattern</a>
<a style="font-size: 119%" href="/blog/tags/guava/">Guava</a>
<a style="font-size: 171%" href="/blog/tags/jdk/">JDK</a>
<a style="font-size: 90%" href="/blog/tags/jmm/">JMM</a>
<a style="font-size: 90%" href="/blog/tags/jvm/">JVM</a>
<a style="font-size: 210%" href="/blog/tags/java/">Java</a>
<a style="font-size: 119%" href="/blog/tags/mac/">Mac</a>
<a style="font-size: 90%" href="/blog/tags/photography/">Photography</a>
<a style="font-size: 164%" href="/blog/tags/solid/">SOLID</a>
<a style="font-size: 119%" href="/blog/tags/site/">Site</a>
<a style="font-size: 119%" href="/blog/tags/solr/">Solr</a>
<a style="font-size: 164%" href="/blog/tags/source-code/">Source Code</a>
<a style="font-size: 90%" href="/blog/tags/spring-mvc/">Spring MVC</a>
<a style="font-size: 119%" href="/blog/tags/spring-solr/">Spring Solr</a>
<a style="font-size: 136%" href="/blog/tags/string/">String</a>
<a style="font-size: 119%" href="/blog/tags/tool/">Tool</a>
<a style="font-size: 119%" href="/blog/tags/web/">Web</a>
<a style="font-size: 90%" href="/blog/tags/ajax/">ajax</a>
<a style="font-size: 90%" href="/blog/tags/dapper/">dapper</a>
<a style="font-size: 90%" href="/blog/tags/distributed-system/">distributed system</a>
<a style="font-size: 90%" href="/blog/tags/tracing/">tracing</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/google-dapper-translation/">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a>
      </li>
    
      <li class="post">
        <a href="/blog/jmm-runtime-data-area/">JMM: Java Runtime Data Area</a>
      </li>
    
      <li class="post">
        <a href="/blog/google-guava-collections/">Google Guava: 2. Collections</a>
      </li>
    
      <li class="post">
        <a href="/blog/google-guava-dealing-with-null/">Google Guava: 1. Dealing With Null</a>
      </li>
    
      <li class="post">
        <a href="/blog/key-solr-concepts/">Key Solr Concepts</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/AlphaWang">@AlphaWang</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'AlphaWang',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/1919wang@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>


<section>
  <h1>Visitors Map</h1>
  <div class="earth">
    <script type="text/javascript" src="//ri.revolvermaps.com/0/0/8.js?i=awaok66hddi&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=49" async="async"></script>
  </div>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Alpha Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253224710'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s5.cnzz.com/z_stat.php%3Fid%3D1253224710%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  











</body>
</html>
